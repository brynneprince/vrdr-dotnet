<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VRDR .NET: Using the VRDR.Messaging Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VRDR .NET
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Using the VRDR.Messaging Library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes how to use the VRDR.Messaging library to simplify implementation of <a class="el" href="namespace_v_r_d_r.html">VRDR</a> message exchange flows.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Death Record Submission</h1>
<p>The diagram below illustrates the messages exchanged during submission of a death record and the subsequent return of coded causes of death and race and ethnicity information.</p>
<p><img src="submission.png" alt="Message Exchange Pattern for Death Record Submission and Coding Response" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md20"></a>
Submit Death Record</h2>
<p>A vital records jurisdiction can create a death record submission as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line">DeathRecord record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a JSON representation of the message (XML is also supported via the ToXML method)</span></div>
<div class="line"><span class="keywordtype">string</span> jsonMessage = message.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>The <code>DeathRecordSubmission</code> constructor will extract information from the supplied <code>DeathRecord</code> to populate the corresponding message property values (<code>StateAuxiliaryIdentifier</code>, <code>CertificateNumber</code>, <code>NCHSIdentifier</code>) automatically.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Extract Death Record</h2>
<p>On receipt of a message, NCHS can parse it, determine the type of the message, and extract a death record using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> DeathRecordSubmission submission:</div>
<div class="line">        var record = submission.DeathRecord;</div>
<div class="line">        var nchsId = submission.NCHSIdentifier;</div>
<div class="line">        ProcessSubmission(record, nchsId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md22"></a>
Acknowledge Death Record</h2>
<p>If extraction was succesful, NCHS can generate an acknowledgement message and send it to the submitting jurisdiction. An <code>AckMessage</code> constructor is available that accepts a source message parameter (<code>submission</code> in the example below) and this is used to initialize <code>AckMessage</code> properties:</p>
<ul>
<li><code>AckMessage.MessageDestination</code> will be assigned the value of <code>source.MessageSource</code></li>
<li><code>AckMessage.MessageSource</code> will be assigned the value of <code>source.MessageDestination</code></li>
<li><code>AckMessage.AckedMessageId</code> will be assigned the value of <code>source.MessageId</code></li>
<li><code>StateAuxiliaryIdentifier</code> will be assigned the value of <code>source.StateAuxiliaryIdentifier</code></li>
<li><code>CertificateNumber</code> will be assigned the value of <code>source.CertificateNumber</code></li>
<li><code>NCHSIdentifier</code> will be assigned the value of <code>source.NCHSIdentifier</code></li>
</ul>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(submission);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>On receipt of the <code>AckMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.NCHSIdentifier;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md23"></a>
Return Coding</h2>
<p>NCHS codes both causes of death, and race and ethnicity of decedents. The VRDR.Messaging library supports returning these two types of information together or separately. Here we will assume the two are coded and sent together, if they were coded separately then the corresponding code blocks would simply be omitted.</p>
<p>Once NCHS have determined the causes of death they can create a <code>CodingResponseMessage</code> to return that information to the jurisdiction:</p>
<div class="fragment"><div class="line"><span class="comment">// Create an empty coding response message</span></div>
<div class="line">CodingResponseMessage message = <span class="keyword">new</span> CodingResponseMessage(<span class="stringliteral">&quot;https://example.org/jurisdiction/endpoint&quot;</span>,</div>
<div class="line">                                                          <span class="stringliteral">&quot;http://nchs.cdc.gov/vrdr_submission&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Assign the business identifiers</span></div>
<div class="line">message.CertificateNumber = 10;</div>
<div class="line">message.StateAuxiliaryIdentifier = <span class="stringliteral">&quot;101010&quot;</span>;</div>
<div class="line">message.DeathYear = 2019;</div>
<div class="line">message.DeathJurisdictionID = <span class="stringliteral">&quot;MA&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Specify additional information</span></div>
<div class="line">message.NCHSReceiptMonthString = <span class="stringliteral">&quot;1&quot;</span>;</div>
<div class="line">message.NCHSReceiptDayString = <span class="stringliteral">&quot;9&quot;</span>;</div>
<div class="line">message.NCHSReceiptYearString = <span class="stringliteral">&quot;2020&quot;</span>;</div>
<div class="line">message.MannerOfDeath = CodingResponseMessage.MannerOfDeathEnum.Accident;</div>
<div class="line">message.CoderStatus = <span class="stringliteral">&quot;8&quot;</span>;</div>
<div class="line">message.ShipmentNumber = <span class="stringliteral">&quot;B202101&quot;</span>;</div>
<div class="line">message.ACMESystemRejectCodes = CodingResponseMessage.ACMESystemRejectEnum.ACMEReject;</div>
<div class="line">message.PlaceOfInjury = CodingResponseMessage.PlaceOfInjuryEnum.Home;</div>
<div class="line">message.OtherSpecifiedPlace = <span class="stringliteral">&quot;Unique Location&quot;</span>;</div>
<div class="line">message.IntentionalReject = <span class="stringliteral">&quot;5&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the ethnicity coding</span></div>
<div class="line">var ethnicity = <span class="keyword">new</span> Dictionary&lt;CodingResponseMessage.HispanicOrigin, <span class="keywordtype">string</span>&gt;();</div>
<div class="line">ethnicity.Add(CodingResponseMessage.HispanicOrigin.DETHNICE, <span class="stringliteral">&quot;&lt;ethnicity-code&gt;&quot;</span>);</div>
<div class="line">ethnicity.Add(CodingResponseMessage.HispanicOrigin.DETHNIC5C, <span class="stringliteral">&quot;&lt;ethnicity-code&gt;&quot;</span>);</div>
<div class="line">message.Ethnicity = ethnicity;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the race coding</span></div>
<div class="line">var race = <span class="keyword">new</span> Dictionary&lt;CodingResponseMessage.RaceCode, <span class="keywordtype">string</span>&gt;();</div>
<div class="line">race.Add(CodingResponseMessage.RaceCode.RACE1E, <span class="stringliteral">&quot;&lt;race-code&gt;&quot;</span>);</div>
<div class="line">race.Add(CodingResponseMessage.RaceCode.RACE17C, <span class="stringliteral">&quot;&lt;race-code&gt;&quot;</span>);</div>
<div class="line">race.Add(CodingResponseMessage.RaceCode.RACEBRG, <span class="stringliteral">&quot;&lt;race-code&gt;&quot;</span>);</div>
<div class="line">message.Race = race;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the cause of death coding</span></div>
<div class="line">message.UnderlyingCauseOfDeath = <span class="stringliteral">&quot;A04.7&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Assign the record axis codes</span></div>
<div class="line">var recordAxisCodes = <span class="keyword">new</span> List&lt;string&gt;();</div>
<div class="line">recordAxisCodes.Add(<span class="stringliteral">&quot;A04.7&quot;</span>);</div>
<div class="line">recordAxisCodes.Add(<span class="stringliteral">&quot;A41.9&quot;</span>);</div>
<div class="line">recordAxisCodes.Add(<span class="stringliteral">&quot;J18.9&quot;</span>);</div>
<div class="line">recordAxisCodes.Add(<span class="stringliteral">&quot;J96.0&quot;</span>);</div>
<div class="line">message.CauseOfDeathRecordAxis = recordAxisCodes;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Assign the entity axis codes</span></div>
<div class="line">var builder = <span class="keyword">new</span> CauseOfDeathEntityAxisBuilder();</div>
<div class="line">builder.Add(<span class="stringliteral">&quot;1&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <span class="stringliteral">&quot;line1_code1&quot;</span>);</div>
<div class="line">builder.Add(<span class="stringliteral">&quot;1&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, <span class="stringliteral">&quot;line1_code2&quot;</span>);</div>
<div class="line">builder.Add(<span class="stringliteral">&quot;2&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <span class="stringliteral">&quot;line2_code1&quot;</span>);</div>
<div class="line">message.CauseOfDeathEntityAxis = builder.ToCauseOfDeathEntityAxis();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a JSON representation of the coding response message</span></div>
<div class="line"><span class="keywordtype">string</span> jsonMessage = message.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>Note that the <code>CodingUpdateMessage</code> class supports the same constructor and properties as <code>CodingResponseMessage</code>. If a second coding message is needed to return causes of death coding or race and ethnicity coding then the same code as above can be used substituting <code>CodingUpdateMessage</code> for <code>CodingResponseMessage</code>.</p>
<p>On receipt of the <code>CodingResponseMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> CodingResponseMessage coding:</div>
<div class="line">        <span class="keywordtype">string</span> nchsId = coding.NCHSIdentifier;</div>
<div class="line">        <span class="keywordtype">string</span> stateAuxId = coding.StateAuxiliaryIdentifier;</div>
<div class="line">        <span class="keywordtype">string</span> cod = coding.CauseOfDeathConditionId;</div>
<div class="line">        Dictionary&lt;CodingResponseMessage.HispanicOrigin, <span class="keywordtype">string</span>&gt; ethnicity = coding.Ethnicity;</div>
<div class="line">        Dictionary&lt;CodingResponseMessage.RaceCode, <span class="keywordtype">string</span>&gt; race = coding.Race;</div>
<div class="line">        List&lt;string&gt; recordAxis = coding.CauseOfDeathRecordAxis;</div>
<div class="line">        List&lt;CauseOfDeathEntityAxisEntry&gt; entityAxis = coding.CauseOfDeathEntityAxis;</div>
<div class="line">        ProcessCoding(nchsId, stateAuxId, ethnicity, race, cod, recordAxis, entityAxis);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md24"></a>
Acknowledge Coding</h2>
<p>If extraction of the coding information was succesful, the jurisdiction can generate an acknowledgement message and send it to NCHS. As described earlier, the <code>AckMessage</code> constructor initializes properties based on the source coding message.</p>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(coding);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>On receipt of the <code>AckMessage</code>, NCHS can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.NCHSIdentifier;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md25"></a>
Failed Death Record Submission</h1>
<p>The diagram below illustrates two message extraction failures:</p>
<ol type="1">
<li>A Death Record Submission could not be extracted from the message and an Extraction Error Response is returned instead of an Acknowledgement.</li>
<li>A Coding Response could not be extracted from the message and an Extraction Error Response is returned instead of an acknowledgement.</li>
</ol>
<p><img src="error.png" alt="Message Exchange Patterns for Failed Message Extraction" class="inline"/></p>
<p>Use of the API to create the Death Record Submission, Acknowledgement and Coding Response messages is identical to that shown above and is not repeated here.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Create an Extraction Error Message</h2>
<div class="fragment"><div class="line">DeathRecordSubmission submissionMessage = <span class="keyword">null</span>;</div>
<div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    submissionMessage = ...;</div>
<div class="line">    ExtractSubmission(submissionMessage);</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create the extraction error message and initialize from properties of the submissionMessage</span></div>
<div class="line">    var errMsg = ExtractionErrorMessage(submissionMessage);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add the issues found during processing</span></div>
<div class="line">    var issues = <span class="keyword">new</span> List&lt;Issue&gt;();</div>
<div class="line">    var issue = <span class="keyword">new</span> Issue(OperationOutcome.IssueSeverity.Fatal, OperationOutcome.IssueType.Invalid, ex.Message);</div>
<div class="line">    issues.Add(issue);</div>
<div class="line">    errMsg.Issues = issues;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create a JSON representation of the coding error response message</span></div>
<div class="line">    <span class="keywordtype">string</span> jsonErrMsg = errMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Send the JSON extraction error response message</span></div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the <code>ExtractionErrorMessage</code> constructor shown above will automatically set the message header properties and copy the business identifier properties (<code>CertificateNumber</code>, <code>StateAuxiliaryIdentifier</code> and <code>NCHSIdentifier</code>) from the supplied <code>DeathRecordSubmission</code>. If the supplied message is <code>null</code> these message properties will need to be set manually instead (not shown).</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Voiding a Death Record</h1>
<p>The diagram below illustrates the sequence of message exchanges between a vital records jurisdiction and NVSS when an initial submission needs to be subsequently voided. Depending on timing, the initial submission may result in a Coding Response or not.</p>
<p><img src="void.png" alt="Message Exchange Pattern for Voiding a Prior Submission" class="inline"/></p>
<p>It is also possible for a jurisdiction to send a <code>VoidMessage</code> to notify NCHS that a particular certificate identifier will not be used in the future. In this case, only the Death Record Void and corresponding Acknowledgement messages from the diagram above are used.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Create a Void Messsage</h2>
<p>There are two ways to create a <code>VoidMessage</code>, the first requires a <code>DeathRecord</code> for the record that will be voided:</p>
<div class="fragment"><div class="line">DeathRecord record = ...;</div>
<div class="line">var voidMsg = <span class="keyword">new</span> VoidMessage(record);</div>
<div class="line">voidMsg.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
</div><!-- fragment --><p>The second method of creating a <code>VoidMessage</code> relies on manual setting of record identifiers:</p>
<div class="fragment"><div class="line">var voidMsg = <span class="keyword">new</span> VoidMessage();</div>
<div class="line">voidMsg.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line">voidMsg.CertificateNumber = <span class="stringliteral">&quot;1034&quot;</span>;</div>
<div class="line">voidMsg.StateAuxiliaryIdentifier = <span class="stringliteral">&quot;A10F3&quot;</span>;</div>
<div class="line">voidMsg.NCHSIdentifier = <span class="stringliteral">&quot;2020MA001034&quot;</span>;</div>
</div><!-- fragment --><p>In both cases the <code>MessageDestination</code> property value is defaulted to <code><a href="http://nchs.cdc.gov/vrdr_submission">http://nchs.cdc.gov/vrdr_submission</a></code> which is the value that should be used for messages sent to NCHS. A JSON representation of the message can be obtained as follows:</p>
<div class="fragment"><div class="line">var jsonVoidMsg = voidMsg.ToJSON();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md29"></a>
Extract Void Information</h2>
<p>On receipt of a message, NCHS can parse it, determine the type of the message, and extract the void record information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> VoidMessage voidMsg:</div>
<div class="line">        var nchsId = voidMsg.NCHSIdentifier;</div>
<div class="line">        var certNo = voidMsg.CertificateNumber;</div>
<div class="line">        var stateAuxId = voidMsg.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessVoid(nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md30"></a>
Acknowledge Void Message</h2>
<p>NCHS can generate an acknowledgement message and send it to jurisdiction as follows.</p>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(voidMsg);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>As described earlier, the <code>AckMessage</code> constructor initializes properties based on the source <code>VoidMessage</code> negating the need to initialize its properties manually.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Process Acknowledgement</h2>
<p>On receipt of the <code>AckMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.NCHSIdentifier;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md32"></a>
Retrying Failed Deliveries</h1>
<p>The diagram below illustrates the case where the vital records jurisdiction does not receive a timely Acknowledgement to a Death Record Submission. To recover, the vital records jurisdiction resends the Death Record Submission.</p>
<p><img src="retry.png" alt="Message Exchange Pattern for Voiding a Prior Submission" class="inline"/></p>
<p>In order to identify whether a message has been received previously, NVSS can compare the message id to those of previously received messages. For this mechanism to work, resent messages must have the same message id as the original.</p>
<p>There are two approaches to creating a message with the same id as a previous message. In the first example below, the id of the original message is saved and then used to set the id of the resent message.</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line">DeathRecord record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the submission message</span></div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Store the sent message id and wait for an acknowledgement</span></div>
<div class="line">SaveSentMessageId(message.MessageId);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Later, when an Acknowledgement has not been received</span></div>
<div class="line">record = ...;</div>
<div class="line">DeathRecordSubmission messageResend = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">messageResend.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line">messageResend.MessageId = RetrieveSentMessageId();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Resend the submission message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>One challenge with the above approach is ensuring that the same death record is sent in both the original and resent message. An alternative, that avoids this challenge, is to save the entire message as illustrated below:</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line">DeathRecord record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the submission message</span></div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Store the sent message and wait for an acknowledgement</span></div>
<div class="line">SaveSentMessage(message.MessageId, message.ToJSON());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Later, when an Acknowledgement has not been received</span></div>
<div class="line">var resendMsgId = GetUnacknowledgedMessageId();</div>
<div class="line">var messageResendJson = RetrieveSentMessage(resendMsgId);</div>
<div class="line">var messageResend = BaseMessage.Parse(messageResendJson);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Resend the message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>The above two approaches are also applicable to the case where a coding response or update needs to be resent.</p>
<h1><a class="anchor" id="autotoc_md33"></a>
Error Handling</h1>
<p>Errors found when parsing messages will be reported either via a <code>System.ArgumentException</code> or a <code><a class="el" href="class_v_r_d_r_1_1_message_parse_exception.html" title="An exception that may be thrown during message parsing">VRDR.MessageParseException</a></code>. A <code>MessageParseException</code> encapsulates information from the message that caused the error. The exception can be used to construct a <code><a class="el" href="class_v_r_d_r_1_1_extraction_error_message.html" title="Class ExtractionErrorMessage is used to communicate that initial processing of a DeathRecordSubmissio...">VRDR.ExtractionErrorMessage</a></code> to report the error to the original sender of the message that caused the error. The code below illustrates this.</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Try to parse an incoming message</span></div>
<div class="line">    var msg = BaseMessage.Parse(messageStream);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (MessageParseException ex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create a message to convey the error back to the original sender</span></div>
<div class="line">    ExtractionErrorMessage errorReply = ex.CreateExtractionErrorMessage();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Validate completeness of error message</span></div>
<div class="line">    ...</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Serialize the error message</span></div>
<div class="line">    <span class="keywordtype">string</span> errorReplyJson = errorReply.ToJSON();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Send the JSON message</span></div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that only those properties that could be extracted from the original message will be used to populate the header fields of the error message, implementations should ensure that the error message header information is complete before sending. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
